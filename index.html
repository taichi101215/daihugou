<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>大富豪 1対3 AI</title>
<style>
  body { font-family: Arial, sans-serif; }
  #settings { margin-bottom: 20px; }
  #player-hand span { cursor: pointer; padding: 5px; border: 1px solid black; margin: 2px; display: inline-block; }
  #player-hand span.selected { background: yellow; }
  #log { margin-top: 20px; height: 200px; overflow-y: scroll; border: 1px solid #ccc; padding: 5px; }
</style>
</head>
<body>

<h1>大富豪 1対3 AI</h1>

<div id="settings">
  <h3>ルール設定</h3>
  <label><input type="checkbox" id="revolution"> 革命</label>
  <label><input type="checkbox" id="eightCut"> 8切り</label>
  <label><input type="checkbox" id="tenDiscard"> 10捨て</label>
  <label><input type="checkbox" id="sevenGive"> 7渡し</label>
  <button id="startBtn">ゲーム開始</button>
</div>

<div id="game" style="display:none;">
  <h3>あなたの手札</h3>
  <div id="player-hand"></div>
  <button id="playBtn" disabled>出す</button>
  <button id="passBtn" disabled>パス</button>
  
  <h3>場のカード</h3>
  <div id="field"></div>

  <h3>ターン / メッセージ</h3>
  <div id="turnInfo"></div>
  
  <div id="log"></div>
</div>

<script>
(() => {
  // カードの数字とスート
  const suits = ['♠', '♥', '♦', '♣'];
  const ranks = ['3','4','5','6','7','8','9','10','J','Q','K','A','2'];
  
  // カード強さ比較用（数字で比較簡易化）
  const rankValues = {};
  ranks.forEach((r,i) => rankValues[r] = i);

  // 状態
  let settings = {revolution:false, eightCut:false, tenDiscard:false, sevenGive:false};
  let deck = [];
  let players = []; // 4人分
  let currentPlayer = 0; // 0=人間
  let fieldCards = [];
  let revolutionOn = false;
  let consecutivePasses = 0;
  let logEl = null;
  let playerHandEl = null;
  let fieldEl = null;
  let turnInfoEl = null;
  let playBtn = null;
  let passBtn = null;
  let selectedCards = [];

  // ログを追加
  function addLog(msg) {
    const p = document.createElement('div');
    p.textContent = msg;
    logEl.appendChild(p);
    logEl.scrollTop = logEl.scrollHeight;
  }

  // カード生成
  function createDeck() {
    const cards = [];
    for(let s of suits) {
      for(let r of ranks) {
        cards.push({suit: s, rank: r});
      }
    }
    return cards;
  }

  // シャッフル
  function shuffle(arr) {
    for(let i = arr.length -1; i>0; i--){
      const j= Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
  }

  // 手札描画
  function renderPlayerHand() {
    playerHandEl.innerHTML = '';
    players[0].forEach((card, idx) => {
      let span = document.createElement('span');
      span.textContent = card.suit + card.rank;
      span.dataset.index = idx;
      span.className = selectedCards.includes(idx) ? 'selected' : '';
      span.onclick = () => {
        if(selectedCards.includes(idx)){
          selectedCards = selectedCards.filter(i => i !== idx);
          span.classList.remove('selected');
        } else {
          selectedCards.push(idx);
          span.classList.add('selected');
        }
        playBtn.disabled = selectedCards.length === 0;
      };
      playerHandEl.appendChild(span);
    });
  }

  // カード同士の強さ比較（革命時は逆）
  function compareCards(card1, card2){
    let v1 = rankValues[card1.rank];
    let v2 = rankValues[card2.rank];
    if(revolutionOn) return v2 - v1; // 強さ逆転
    else return v1 - v2;
  }

  // 出せるかの簡易判定（場にカードがなければいつでもOK）
  function canPlay(cards){
    if(cards.length === 0) return false;
    if(fieldCards.length === 0) return true;
    if(cards.length !== fieldCards.length) return false;
    // すべて同じランクかつ前の場より強い必要あり
    let rank = cards[0].rank;
    if(!cards.every(c => c.rank === rank)) return false;
    // 比較は先頭のカード同士
    let cmp = compareCards(cards[0], fieldCards[0]);
    return cmp > 0;
  }

  // AIプレイヤーのカード出し（簡易）
  function aiPlay(playerIdx){
    const hand = players[playerIdx];
    // 場が空なら最小のカード1枚出す
    if(fieldCards.length === 0){
      // 最小ランクのカード1枚を探す
      let minCardIdx = 0;
      for(let i=1; i<hand.length; i++){
        if(compareCards(hand[i], hand[minCardIdx]) < 0){
          minCardIdx = i;
        }
      }
      let played = [hand[minCardIdx]];
      // remove played from hand
      hand.splice(minCardIdx,1);
      return played;
    }
    // 場の枚数と同じ枚数で出せるカード探す
    let needCount = fieldCards.length;
    // 探していく - 同じランクかつ強いもの
    // ここは簡易、1枚出しのみ対応
    if(needCount !== 1) return null; // AIは複数枚出し非対応

    for(let i=0; i<hand.length; i++){
      if(compareCards(hand[i], fieldCards[0]) > 0){
        let played = [hand[i]];
        hand.splice(i,1);
        return played;
      }
    }
    // 出せるカードなしはパス
    return null;
  }

  // ゲームのターン進行
  function nextTurn(){
    do {
      currentPlayer = (currentPlayer + 1) % 4;
    } while(players[currentPlayer].length === 0); // 手札なければスキップ

    turnInfoEl.textContent = `ターン：${currentPlayer===0?'あなた':`AI${currentPlayer}`}(${players[currentPlayer].length}枚)`;
    
    if(currentPlayer === 0) {
      // プレイヤーターン開始
      selectedCards = [];
      renderPlayerHand();
      playBtn.disabled = true;
      passBtn.disabled = false;
      addLog("あなたのターンです。カードを選んで「出す」か「パス」を押してください。");
    } else {
      playBtn.disabled = true;
      passBtn.disabled = true;
      addLog(`AI${currentPlayer}のターンです。`);
      setTimeout(() => {
        const played = aiPlay(currentPlayer);
        if(played){
          fieldCards = played;
          addLog(`AI${currentPlayer}が${played.map(c => c.suit+c.rank).join(',')}を出しました`);
          consecutivePasses = 0;
          if(players[currentPlayer].length === 0){
            addLog(`AI${currentPlayer}が上がりました！`);
          }
          checkSpecialCards(played, currentPlayer);
          nextTurn();
        } else {
          addLog(`AI${currentPlayer}はパスしました。`);
          consecutivePasses++;
          if(consecutivePasses >= 3){
            addLog("場が流れました。場札をリセットします。");
            fieldCards = [];
            consecutivePasses = 0;
          }
          nextTurn();
        }
      }, 1000);
    }
  }

  // 特殊カード処理（革命・8切り・10捨て・7渡し簡易）
  function checkSpecialCards(played, playerIdx){
    // 革命（4枚同じランク）
    if(settings.revolution){
      if(played.length === 4 && played.every(c => c.rank === played[0].rank)){
        revolutionOn = !revolutionOn;
        addLog(`革命発動！カードの強さが${revolutionOn ? '逆転' : '元に戻りました'}`);
      }
    }
    // 8切り
    if(settings.eightCut){
      if(played.some(c => c.rank === '8')){
        addLog('8切り！場札をリセットします。');
        fieldCards = [];
        consecutivePasses = 0;
      }
    }
    // 10捨て(10を出せば1枚捨てOKだが簡易はログだけ)
    if(settings.tenDiscard){
      if(played.some(c => c.rank === '10')){
        addLog(`10捨て発動！カードを1枚捨てられます（未実装）`);
      }
    }
    // 7渡し(ゲーム開始時のみ簡易実装として先頭と交換など実装可能、現状未対応)
  }

  // プレイヤーのカード出し処理
  function playerPlay(){
    const indices = selectedCards.slice().sort((a,b)=>b - a);
    const playCards = indices.map(i => players[0][i]);
    if(!canPlay(playCards)){
      alert('出せないカードの組み合わせです。ルールを確認してください。');
      return;
    }
    // 手札減らす
    for(let i of indices){
      players[0].splice(i, 1);
    }
    fieldCards = playCards;
    addLog(`あなたが${playCards.map(c => c.suit+c.rank).join(',')}を出しました`);
    consecutivePasses = 0;
    checkSpecialCards(playCards, 0);
    if(players[0].length === 0){
      addLog('あなたが上がりました！ゲーム終了');
      endGame();
      return;
    }
    playBtn.disabled = true;
    passBtn.disabled = true;
    renderPlayerHand();
    nextTurn();
  }

  // プレイヤーパス処理
  function playerPass(){
    addLog('あなたはパスしました。');
    passBtn.disabled = true;
    playBtn.disabled = true;
    consecutivePasses++;
    if(consecutivePasses >= 3){
      addLog("場が流れました。場札をリセットします。");
      fieldCards = [];
      consecutivePasses = 0;
    }
    nextTurn();
  }

  // ゲーム終了処理
  function endGame(){
    playBtn.disabled = true;
    passBtn.disabled = true;
    turnInfoEl.textContent = "ゲーム終了";
  }

  // ゲーム開始処理
  function startGame(){
    // 設定読み込み
    settings.revolution = document.getElementById('revolution').checked;
    settings.eightCut = document.getElementById('eightCut').checked;
    settings.tenDiscard = document.getElementById('tenDiscard').checked;
    settings.sevenGive = document.getElementById('sevenGive').checked;
    
    addLog("ゲーム開始");
    
    // 山札作成＆シャッフル
    deck = createDeck();
    shuffle(deck);
    // 配る(4人均等)
    players = [[],[],[],[]];
    for(let i=0; i<deck.length; i++){
      players[i%4].push(deck[i]);
    }
    // 手札ソート（rank値で）
    for(let p=0; p<4; p++){
      players[p].sort((a,b) => rankValues[a.rank] - rankValues[b.rank]);
    }

    // ゲームUI表示
    document.getElementById('game').style.display = 'block';

    // 初期状態
    currentPlayer = -1;
    fieldCards = [];
    revolutionOn = false;
    consecutivePasses = 0;
    selectedCards = [];

    renderPlayerHand();
    turnInfoEl.textContent = '';
    fieldEl.textContent = '';

    nextTurn();
  }

  // 初期化
  window.onload = () => {
    logEl = document.getElementById('log');
    playerHandEl = document.getElementById('player-hand');
    fieldEl = document.getElementById('field');
    turnInfoEl = document.getElementById('turnInfo');
    playBtn = document.getElementById('playBtn');
    passBtn = document.getElementById('passBtn');

    document.getElementById('startBtn').onclick = () => {
      logEl.innerHTML = '';
      startGame();
    };
    playBtn.onclick = playerPlay;
    passBtn.onclick = playerPass;
  };
})();
</script>

</body>
</html>
